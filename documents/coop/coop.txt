29.02.2012: начал делать кооператив (несколько игроков в режиме одиночной игры), начну с убирания проверки на прямое соединение там где надо...заметил в CLevel::Connect2Server вот что: верификация файлов идёт только если соединение не прямое...если поставить флаг "прямое соединение" то этот шаг пропускается...но это у клиента, подобное у сервера должно быть...

01.03.2012: требуется сделать загрузку геймдаты из разных папок для кооператива и сетевой...но как это провернуть...

апд: ладно, можно играть и с геймдатой сетевой...
сейчас дошёл до загрузки уровня клиента (клиент ищет карту all, надо найти где эта беда передаётся)

05.03.2012: сделал передачу названия локации и загрузку этой локации у клиента...теперь всё падает когда загрузка уже завершена, в 238D40...после CObjectList::net_Export (точнее его не завершает)

апд: убрал самопальную синхру (весь экспорт импорт), ломаться всё перестало...думаю это было сохранение, ток слетело изза того что у меня на все вызовы идут мои функции...надо сделать условный вызов по месту вызова...

НО клиент не может прицепиться (возможно щас проблемы с сетью...пишет "инвалид хост", то есть вообще не подключается никак...

апд: попробую опять собрать дедик с синглом...

апд: почемуто не находит данные в конфигах дедик...хотя флаг не затронут =/

06.03.2012: у дедика первым лоадится аммо на классе артефакта (ЧТО ЗА НАХ?) и это всё из префетча!

добавил параметр -noprefetch и всё пошло дальше

апд: судя по логу уже добрались до самой игры...карта загружена, сервер и клиент созданы, коннект синх за 0 мс...что там после этой стадии идёт?)

07.03.2012: тестирую кооп в виде двух клиентов (заставил бук демона увидеть игру)...клиент коннектится но на одной из стадий всё ломает и получаем сраный фэйл старта клиента...

апд: что я получаю при коннекте:

@ start client(169.254.221.178)
- IPureClient : created on port 5447!
* HOST #1: zaton

* WARNING: player not logged in
* client : connection accepted - <All Ok>
* Loading HOM: d:\s.t.a.l.k.e.r. - call of pripyat 1.6.0.2\soproject\gamedata\levels\zaton\level.hom
* calculating checksum of level.geom
* connection sync: 0 ms
* t-report - base: 592, 205194 K
* t-report - lmap: 26, 26627 K
* [win32]: free[1146320 K], reserved[185332 K], committed[765436 K]
* [ D3D ]: textures[231822 K]
* [x-ray]: crt heap[214746 K], process heap[13529 K], game lua[2151 K], render[206 K]
* [x-ray]: economy: strings[8185 K], smem[1340 K]
! Failed to start client. Check the connection or level existance.

при подключении в нетворке: 
- IPureClient : created on port 5447!
* HOST #1: mp_atp

* client : connection accepted - <All Ok>
* Loading HOM: d:\s.t.a.l.k.e.r. - call of pripyat 1.6.0.2\soproject\gamedata\levels\mp_atp\level.hom
level script (d:\s.t.a.l.k.e.r. - call of pripyat 1.6.0.2\soproject\gamedata\levels\mp_atp\location_main.script) not exist
* calculating checksum of level.geom
* connection sync: 0 ms
* t-report - base: 383, 150714 K
* t-report - lmap: 6, 6144 K
Loading objects...
Loading models...
* [prefetch] time:    4363 ms
* [prefetch] memory:  14050Kb
* [win32]: free[1291464 K], reserved[185592 K], committed[620032 K]
* [ D3D ]: textures[217136 K]
* [x-ray]: crt heap[153330 K], process heap[13812 K], game lua[2756 K], render[186 K]
* [x-ray]: economy: strings[8281 K], smem[3506 K]
009 connected
* MEMORY USAGE: 197566 K
* End of synchronization A[1] R[1]
* [win32]: free[1170604 K], reserved[190980 K], committed[735504 K]
* [ D3D ]: textures[227564 K]
* [x-ray]: crt heap[202006 K], process heap[13812 K], game lua[2104 K], render[1116 K]
* [x-ray]: economy: strings[8372 K], smem[7747 K]


апд: возможно коннект ломается на смене флага тут: 1025622E...точнее не "возможно" а именно там, т.к. других мест смены флага нет (не учитывая те которые проходят нормально)

апд: поправил сервер (там проверка была на два параметра и упаковывала в пакет 0 1 или 2, надо 0 для нормального коннекта.

апд: получил вылет 242F89 + 79C88

апд: последняя версия:

- IPureClient : created on port 5447!
* HOST #1: zaton

* WARNING: player not logged in
* client : connection accepted - <All Ok>
* Loading HOM: d:\s.t.a.l.k.e.r. - call of pripyat 1.6.0.2\soproject\gamedata\levels\zaton\level.hom
* calculating checksum of level.geom
* connection sync: 0 ms
* t-report - base: 592, 205194 K
* t-report - lmap: 26, 26627 K
* WARNING: player not logged in
Loading objects...
Loading models...
* [prefetch] time:    15869 ms
* [prefetch] memory:  78085Kb
* [win32]: free[875296 K], reserved[192320 K], committed[1029472 K]
* [ D3D ]: textures[360175 K]
* [x-ray]: crt heap[301258 K], process heap[13962 K], game lua[2158 K], render[249 K]
* [x-ray]: economy: strings[8635 K], smem[10192 K]

апд: вылет 79C88 (предыдущий с актором исправлен...ну практически)

апд: кажется понял бяду...ведь монстрам нужна аисетка на обоих сторонах, вот тут эта хрень и идёт...вылет изза отсутсвия данных в g_pAI_Space + 0x24

как я помню в мп режиме тоже стоило сделать загрузку аи спейс и всё стало работать у клиента...это и сделаю тут :)

апд: при попытке забиндить лвл ченжер всё слетело (пля да сколько можно)

08.03.2012: бяда при бинде изза того что обращение идёт к alife() что у клиента равно нулю...но в нетворк модуле все монстры работают, а они тоже к нему обращаются в скриптах >< странно...может я клиентам тоже алайф подключил?

апд: сделаю работу биндера только на стороне сервера...

при получении флага дедика (проверка при использовании биндера) есть 6 байт, далее проверка сама 3 байта....а нам надо:
1. вызов нашей функции проверки - 5 байт
2. проверка результата нашей функции - 3 байта (83 F8 00)
и ещё один байт остаётся лишним :) всё круто

апд: чувствую я в чем то бяда...все ошибки скриптовые эти не в тему...может при работе в сингле какие то лишние объекты передаются по сети?

надо будет проверить какие объекты пакуются при подключении...

апд: ПАМЯТКА: надо убрать проверку на сингл в CLevel::ClientSend (для синхры)

апд: убрал нахер все объекты из алайфа кроме актора, в итоге всё тот же вылет в хрЛогик...бля  да кто же его провоцирует!

09.03.2012: пришла в голову мысль - ведь акторы должны быть мп для того чтобы работала синхра...заменю ка на мп акторов создание

13.03.2012: щас понял что ошибся...надо добавить синхру от мп актора в обычный класс актора, тогда он останется завязанный на скриптах, не будет ломать сервер, и будет синхронизироваться...а вот остальные игроки при подключении должны уже создавать экземпляр мп актора, который не связан со скриптами (Entity мп актора не взаимодействует со скриптами вообще) и синхронизируется...в итоге получаем решение всех проблем

ps: Mass Effect forever!!!